# نظام إدارة المستخدمين - Sabq AI CMS

## نظرة عامة

نظام إدارة المستخدمين في Sabq AI CMS هو نظام شامل ومتطور يوفر جميع الأدوات اللازمة لإدارة المستخدمين والصلاحيات والأمان بطريقة احترافية وآمنة.

## المميزات الأساسية

### 1. إدارة المستخدمين
- **قائمة المستخدمين**: عرض جميع المستخدمين مع البحث والتصفية المتقدمة
- **تفاصيل المستخدم**: عرض شامل لمعلومات المستخدم والنشاط والجلسات
- **إضافة مستخدم**: إنشاء حسابات جديدة مع التحقق من صحة البيانات
- **تعديل المستخدم**: تحديث بيانات المستخدمين والصلاحيات
- **حذف المستخدم**: حذف آمن للمستخدمين مع الحماية من الحذف الخاطئ

### 2. نظام الصلاحيات
- **أدوار متعددة**: قارئ، محرر، مشرف
- **إدارة الحالات**: نشط، غير نشط، معلق، محظور
- **تفعيل/إيقاف الحسابات**: تحكم كامل في حالة الحسابات
- **المصادقة الثنائية**: دعم تفعيل/إيقاف المصادقة الثنائية

### 3. الأمان والحماية
- **Rate Limiting**: حماية من الهجمات والاستخدام المفرط
- **تسجيل الأنشطة**: تسجيل شامل لجميع العمليات الإدارية
- **قفل الحسابات**: قفل تلقائي للحسابات عند المحاولات الفاشلة
- **إدارة الجلسات**: عرض وإنهاء جلسات المستخدمين
- **تغيير كلمة المرور**: تغيير كلمات المرور من قبل المشرف

### 4. البحث والتصفية
- **البحث المتقدم**: بحث بالاسم، البريد الإلكتروني، الدور
- **تصفية متعددة**: تصفية حسب الدور، الحالة، تاريخ الإنشاء
- **ترتيب مخصص**: ترتيب النتائج حسب معايير مختلفة
- **صفحات متعددة**: عرض النتائج مع ترقيم الصفحات

### 5. العمليات المجمعة
- **اختيار متعدد**: اختيار مستخدمين متعددين للعمليات المجمعة
- **حذف مجمع**: حذف مستخدمين متعددين مع التأكيد
- **تصدير البيانات**: تصدير قوائم المستخدمين (مخطط مستقبلي)

## البنية التقنية

### APIs الخلفية

#### 1. GET /api/admin/users
**الوصف**: جلب قائمة المستخدمين مع البحث والتصفية

**معاملات الاستعلام**:
- `query`: نص البحث (اختياري)
- `role`: تصفية حسب الدور (اختياري)
- `status`: تصفية حسب الحالة (اختياري)
- `page`: رقم الصفحة (افتراضي: 1)
- `limit`: عدد النتائج في الصفحة (افتراضي: 20، أقصى: 100)
- `sortBy`: حقل الترتيب (افتراضي: created_at)
- `sortOrder`: اتجاه الترتيب (asc/desc، افتراضي: desc)

**الاستجابة**:
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "uuid",
        "name": "اسم المستخدم",
        "email": "user@example.com",
        "phone": "+966123456789",
        "role": "reader",
        "status": "active",
        "is_verified": true,
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z",
        "last_login": "2024-01-01T00:00:00Z",
        "sessionsCount": 2,
        "activityCount": 15,
        "isLocked": false,
        "failed_login_attempts": 0
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "totalCount": 150,
      "totalPages": 8,
      "hasNext": true,
      "hasPrev": false
    },
    "stats": {
      "byRole": {
        "reader": 100,
        "editor": 30,
        "admin": 20
      },
      "byStatus": {
        "active": 140,
        "inactive": 10
      },
      "total": 150
    }
  }
}
```

#### 2. POST /api/admin/users
**الوصف**: إنشاء مستخدم جديد

**البيانات المطلوبة**:
```json
{
  "name": "اسم المستخدم",
  "email": "user@example.com",
  "phone": "+966123456789",
  "password": "كلمة_مرور_قوية",
  "role": "reader",
  "status": "active",
  "two_factor": false
}
```

**الاستجابة**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "name": "اسم المستخدم",
      "email": "user@example.com",
      "phone": "+966123456789",
      "role": "reader",
      "status": "active",
      "is_verified": true,
      "created_at": "2024-01-01T00:00:00Z"
    }
  },
  "message": "تم إنشاء المستخدم بنجاح"
}
```

#### 3. GET /api/admin/users/[id]
**الوصف**: جلب تفاصيل مستخدم محدد

**الاستجابة**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "name": "اسم المستخدم",
      "email": "user@example.com",
      "phone": "+966123456789",
      "role": "reader",
      "status": "active",
      "is_verified": true,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z",
      "last_login": "2024-01-01T00:00:00Z",
      "failed_login_attempts": 0,
      "isLocked": false,
      "locked_until": null,
      "sessionsCount": 2,
      "activityCount": 15,
      "sessions": [
        {
          "id": "uuid",
          "device_info": "Mozilla/5.0...",
          "ip_address": "192.168.1.1",
          "created_at": "2024-01-01T00:00:00Z",
          "last_activity": "2024-01-01T00:00:00Z",
          "is_active": true
        }
      ],
      "audit_logs": [
        {
          "id": "uuid",
          "action": "LOGIN",
          "resource": "session",
          "details": {},
          "ip_address": "192.168.1.1",
          "user_agent": "Mozilla/5.0...",
          "created_at": "2024-01-01T00:00:00Z",
          "success": true
        }
      ]
    },
    "stats": {
      "byAction": {
        "LOGIN": 10,
        "LOGOUT": 8,
        "PROFILE_UPDATED": 2
      },
      "activity": {
        "totalActions": 20,
        "successfulActions": 18,
        "failedActions": 2,
        "lastActivity": "2024-01-01T00:00:00Z"
      }
    }
  }
}
```

#### 4. PUT /api/admin/users/[id]
**الوصف**: تحديث بيانات المستخدم

**البيانات المطلوبة**:
```json
{
  "name": "اسم المستخدم المحدث",
  "phone": "+966123456789",
  "role": "editor",
  "status": "active",
  "two_factor": true
}
```

#### 5. DELETE /api/admin/users/[id]
**الوصف**: حذف مستخدم

**الاستجابة**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "name": "اسم المستخدم",
      "email": "user@example.com",
      "role": "reader"
    }
  },
  "message": "تم حذف المستخدم بنجاح"
}
```

#### 6. PATCH /api/admin/users/[id]
**الوصف**: عمليات خاصة (تغيير كلمة المرور، إلغاء القفل، إنهاء الجلسات)

**أمثلة على العمليات**:

**تغيير كلمة المرور**:
```json
{
  "action": "change_password",
  "newPassword": "كلمة_مرور_جديدة",
  "forceChange": true
}
```

**إلغاء قفل الحساب**:
```json
{
  "action": "unlock_account"
}
```

**إنهاء جميع الجلسات**:
```json
{
  "action": "terminate_sessions"
}
```

#### 7. DELETE /api/admin/users?ids=id1,id2,id3
**الوصف**: حذف مستخدمين متعددين

### المكونات الأمامية

#### 1. UserManagement
**الوصف**: المكون الرئيسي لإدارة المستخدمين

**المميزات**:
- عرض قائمة المستخدمين مع الإحصائيات
- بحث وتصفية متقدمة
- عمليات مجمعة (حذف متعدد)
- ترقيم الصفحات
- عرض حالة التحميل والأخطاء

#### 2. UserDetails
**الوصف**: مكون عرض تفاصيل المستخدم

**المميزات**:
- عرض معلومات المستخدم الكاملة
- إحصائيات النشاط
- قائمة الجلسات النشطة
- سجل الأنشطة
- عمليات سريعة (قفل/إلغاء قفل، تغيير كلمة المرور)

#### 3. UserForm
**الوصف**: نموذج إنشاء وتعديل المستخدمين

**المميزات**:
- التحقق من صحة البيانات في الوقت الفعلي
- فحص قوة كلمة المرور
- التحقق من توفر البريد الإلكتروني
- واجهة مستخدم سهلة ومتجاوبة

## معايير الأمان

### 1. المصادقة والتفويض
- **Bearer Token**: استخدام JWT tokens للمصادقة
- **فحص الصلاحيات**: التحقق من صلاحية المشرف لجميع العمليات
- **منع التلاعب الذاتي**: منع المشرف من تعديل صلاحياته أو حذف حسابه

### 2. التحقق من البيانات
- **Zod Validation**: استخدام مكتبة Zod للتحقق من صحة البيانات
- **تنظيف المدخلات**: تنظيف جميع المدخلات من XSS والحقن البرمجي
- **فحص قوة كلمة المرور**: التحقق من قوة كلمة المرور قبل الحفظ

### 3. Rate Limiting
- **حدود الطلبات**: تطبيق حدود مختلفة حسب نوع العملية
- **منع الهجمات**: حماية من هجمات brute force والاستخدام المفرط

### 4. التسجيل والتدقيق
- **تسجيل شامل**: تسجيل جميع العمليات الإدارية في audit_logs
- **تتبع IP والجهاز**: تسجيل عنوان IP ومعلومات الجهاز
- **تسجيل النجاح والفشل**: تسجيل نتيجة كل عملية

## إرشادات الاستخدام

### 1. إضافة مستخدم جديد
1. انتقل إلى صفحة إدارة المستخدمين
2. اضغط على "إضافة مستخدم جديد"
3. املأ النموذج بالبيانات المطلوبة
4. اختر الدور والحالة المناسبة
5. اضغط "إنشاء المستخدم"

### 2. تعديل مستخدم موجود
1. ابحث عن المستخدم في القائمة
2. اضغط على أيقونة "تعديل" أو ادخل إلى صفحة التفاصيل
3. عدل البيانات المطلوبة
4. اضغط "حفظ التعديلات"

### 3. إدارة الجلسات
1. ادخل إلى صفحة تفاصيل المستخدم
2. انتقل إلى تبويب "الجلسات"
3. اضغط "إنهاء جميع الجلسات" لإنهاء جميع جلسات المستخدم

### 4. تغيير كلمة المرور
1. في صفحة تفاصيل المستخدم، اضغط "تغيير كلمة المرور"
2. أدخل كلمة المرور الجديدة
3. اختر ما إذا كنت تريد إجبار المستخدم على تغييرها في الدخول التالي

### 5. قفل/إلغاء قفل الحساب
1. في صفحة تفاصيل المستخدم
2. اضغط "إلغاء قفل الحساب" إذا كان الحساب مقفلاً
3. أو غير الحالة إلى "محظور" لقفل الحساب

## الأخطاء الشائعة وحلولها

### 1. "البريد الإلكتروني مستخدم بالفعل"
**الحل**: تأكد من عدم وجود مستخدم آخر بنفس البريد الإلكتروني

### 2. "كلمة المرور ضعيفة"
**الحل**: استخدم كلمة مرور تحتوي على:
- 8 أحرف على الأقل
- حرف كبير وصغير
- رقم واحد على الأقل
- رمز خاص واحد على الأقل

### 3. "تم تجاوز الحد الأقصى للطلبات"
**الحل**: انتظر قليلاً قبل إعادة المحاولة

### 4. "لا يمكن حذف حسابك الحالي"
**الحل**: لا يمكن للمشرف حذف حسابه الخاص، اطلب من مشرف آخر القيام بذلك

## التطوير المستقبلي

### مميزات مخططة
- **تصدير البيانات**: تصدير قوائم المستخدمين بصيغ مختلفة
- **استيراد المستخدمين**: استيراد مستخدمين من ملفات CSV/Excel
- **إشعارات البريد الإلكتروني**: إرسال إشعارات للمستخدمين عند تغيير البيانات
- **تقارير متقدمة**: تقارير مفصلة عن نشاط المستخدمين
- **API للتكامل**: APIs للتكامل مع أنظمة خارجية

### تحسينات الأداء
- **Cache**: تطبيق cache للاستعلامات الشائعة
- **Pagination المتقدمة**: تحسين أداء الصفحات الكبيرة
- **البحث المتقدم**: تحسين أداء البحث والتصفية

## الدعم والمساعدة

للحصول على المساعدة أو الإبلاغ عن مشاكل:
1. راجع هذا التوثيق أولاً
2. تحقق من ملفات السجل (logs)
3. تواصل مع فريق التطوير

---

**تاريخ آخر تحديث**: ديسمبر 2024  
**الإصدار**: 1.0.0  
**المطور**: فريق Sabq AI CMS 