// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  name              String
  hashed_password   String
  role              String    @default("user") // user, editor, admin
  is_verified       Boolean   @default(false)
  avatar_url        String?
  bio               String?
  preferences       Json?     // JSON object for user preferences
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  last_login        DateTime?
  
  // Relations
  articles          Article[]
  sessions          Session[]
  analytics_events  AnalyticsEvent[]
  user_interests    UserInterest[]
  recommendations   Recommendation[]
  article_likes     ArticleLike[]
  article_bookmarks ArticleBookmark[]
  comments          Comment[]
  reason_feedback   RecommendationReasonFeedback[]
  
  @@map("users")
}

model Session {
  id             String    @id @default(uuid())
  user_id        String?
  session_token  String    @unique
  device_info    Json?     // Device, browser, OS info
  ip_address     String?
  started_at     DateTime  @default(now())
  ended_at       DateTime?
  duration       Int?      // in seconds
  
  // Relations
  user           User?     @relation(fields: [user_id], references: [id])
  analytics_events AnalyticsEvent[]
  reason_feedback RecommendationReasonFeedback[]
  
  @@map("sessions")
}

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  color       String?   // Hex color for UI
  icon        String?   // Icon name or URL
  is_active   Boolean   @default(true)
  sort_order  Int       @default(0)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  // Relations
  articles    Article[]
  user_interests UserInterest[]
  
  @@map("categories")
}

model Article {
  id              String    @id @default(uuid())
  title           String
  slug            String    @unique
  summary         String?
  content         String
  featured_image  String?
  category_id     String
  author_id       String
  status          String    @default("draft") // draft, published, archived
  featured        Boolean   @default(false)
  view_count      Int       @default(0)
  like_count      Int       @default(0)
  comment_count   Int       @default(0)
  reading_time    Int?      // estimated reading time in minutes
  tags            String[]  // Array of tags
  seo_data        Json?     // SEO metadata
  published_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relations
  category        Category  @relation(fields: [category_id], references: [id])
  author          User      @relation(fields: [author_id], references: [id])
  analytics_events AnalyticsEvent[]
  recommendations Recommendation[]
  article_likes   ArticleLike[]
  article_bookmarks ArticleBookmark[]
  comments        Comment[]
  
  @@map("articles")
}

model AnalyticsEvent {
  id           String    @id @default(uuid())
  event_type   String    // page_view, scroll, like, share, comment, search, navigate, reading_time, etc.
  event_data   Json      // Additional event-specific data
  article_id   String?   // Related article (if applicable)
  user_id      String?   // User who performed the action (if logged in)
  session_id   String?   // Session identifier
  ip_address   String?   // For anonymous tracking
  user_agent   String?   // Browser/device information
  referrer     String?   // Where the user came from
  page_url     String?   // Current page URL
  timestamp    DateTime  @default(now())
  processed    Boolean   @default(false) // For batch processing
  
  // Relations
  article      Article?  @relation(fields: [article_id], references: [id])
  user         User?     @relation(fields: [user_id], references: [id])
  session      Session?  @relation(fields: [session_id], references: [id])
  
  @@map("analytics_events")
}

model UserInterest {
  id            String    @id @default(uuid())
  user_id       String
  category_id   String?
  topic         String?   // Specific topic/keyword
  interest_score Float    @default(0.0) // Calculated interest score
  decay_factor  Float    @default(1.0) // For time-based decay
  last_updated  DateTime  @default(now())
  created_at    DateTime  @default(now())
  
  // Relations
  user          User      @relation(fields: [user_id], references: [id])
  category      Category? @relation(fields: [category_id], references: [id])
  
  @@unique([user_id, category_id])
  @@unique([user_id, topic])
  @@map("user_interests")
}

model Recommendation {
  id             String    @id @default(uuid())
  user_id        String
  article_id     String
  score          Float     // Recommendation score
  reason         String?   // Why this was recommended
  algorithm      String    // Which algorithm generated this
  context        String?   // Context of recommendation (homepage, article_page, etc.)
  shown_at       DateTime?
  clicked_at     DateTime?
  dismissed_at   DateTime?
  created_at     DateTime  @default(now())
  expires_at     DateTime? // When recommendation expires
  
  // Relations
  user           User      @relation(fields: [user_id], references: [id])
  article        Article   @relation(fields: [article_id], references: [id])
  reason_feedback RecommendationReasonFeedback[]
  
  @@unique([user_id, article_id, context])
  @@map("recommendations")
}

model RecommendationReasonFeedback {
  id                    String    @id @default(uuid())
  recommendation_id     String
  reason_text           String    // The reason text that was shown
  feedback              String    // "clear" | "unclear" | "helpful" | "not_helpful"
  note                  String?   // Optional user note
  improvement_suggestion String?   // Optional improvement suggestion
  user_id               String?   // User who provided feedback (if logged in)
  session_id            String?   // Session identifier
  ip_address            String?   // For anonymous feedback
  user_agent            String?   // Browser/device information
  created_at            DateTime  @default(now())
  
  // Relations
  recommendation        Recommendation @relation(fields: [recommendation_id], references: [id])
  user                  User?          @relation(fields: [user_id], references: [id])
  session               Session?       @relation(fields: [session_id], references: [id])
  
  @@map("recommendation_reason_feedback")
}

model ArticleLike {
  id         String   @id @default(uuid())
  user_id    String
  article_id String
  created_at DateTime @default(now())
  
  // Relations
  user       User     @relation(fields: [user_id], references: [id])
  article    Article  @relation(fields: [article_id], references: [id])
  
  @@unique([user_id, article_id])
  @@map("article_likes")
}

model ArticleBookmark {
  id         String   @id @default(uuid())
  user_id    String
  article_id String
  created_at DateTime @default(now())
  
  // Relations
  user       User     @relation(fields: [user_id], references: [id])
  article    Article  @relation(fields: [article_id], references: [id])
  
  @@unique([user_id, article_id])
  @@map("article_bookmarks")
}

model Comment {
  id         String   @id @default(uuid())
  content    String
  user_id    String
  article_id String
  parent_id  String?  // For nested comments
  is_approved Boolean @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  // Relations
  user       User     @relation(fields: [user_id], references: [id])
  article    Article  @relation(fields: [article_id], references: [id])
  parent     Comment? @relation("CommentReplies", fields: [parent_id], references: [id])
  replies    Comment[] @relation("CommentReplies")
  
  @@map("comments")
}

model Integration {
  id          String   @id @default(uuid())
  name        String   @unique
  type        String   // analytics, marketing, social, etc.
  config      Json     // Configuration data
  is_active   Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@map("integrations")
} 