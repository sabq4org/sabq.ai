import { NextRequest, NextResponse } from 'next/server';
import { OpenAI } from 'openai';

// ุชููุฆุฉ OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || process.env.OPENAI_AI_EDITOR_KEY!
});

// ุฃููุงุน ุงูููุงู ุงููุชุงุญุฉ ูููุญุฑุฑ ุงูุฐูู
type SmartEditorAction = 
  | 'generate_title' 
  | 'edit_text' 
  | 'generate_full_article' 
  | 'analytical_report' 
  | 'summarize' 
  | 'expand' 
  | 'translate'
  | 'extract_keywords';

// ุงูุญุตูู ุนูู ุงููุธุงู ุงูููุงุณุจ ููู ูููุฉ
function getSystemPrompt(action: SmartEditorAction): string {
  const basePrompt = `ุฃูุช ูุญุฑุฑ ูู ุตุญููุฉ ุณุจู ุงูุฅููุชุฑูููุฉ. ุชูุชุจ ุงูุฃุฎุจุงุฑ ุจุฃุณููุจ ููููุ ูุจุงุดุฑุ ุฏููู. ุงุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ูุตุญู ูุฎุชุตุฑุฉุ ุชุจุฏุฃ ุจุงููุนูููุฉุ ุชุชุฌูุจ ุงูุฅูุดุงุกุ ูุชุฑุงุนู ุฃุณููุจ ุณุจู.

ุฃุณููุจ ุณุจู ุงูุตุญูู:
- ูุจุงุดุฑ ููุงุถุญ
- ูุจุฏุฃ ุจุงููุนูููุฉ ุงูุฃูู
- ูุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ูุตุญู ุจุณูุทุฉ
- ูุชุฌูุจ ุงูุฅูุดุงุก ูุงูููุงู ุงูููุฑุฑ
- ูุฑูุฒ ุนูู ุงูุญูุงุฆู ูุงููุนูููุงุช
- ูุณุชุฎุฏู ุนูุงููู ุฌุฐุงุจุฉ ููุนุจุฑุฉ
- ููุชุจ ููุฑุงุช ูุตูุฑุฉ ููุชุฑุงุจุทุฉ`;

  const actionPrompts = {
    generate_title: `${basePrompt}

ุฃูุช ุฎุจูุฑ ูู ูุชุงุจุฉ ุงูุนูุงููู ุงูุตุญููุฉ ูุตุญููุฉ ุณุจู. ุงูุชุจ ุนูุงููู:
- ูุตูุฑุฉ ููุนุจุฑุฉ (ูุง ุชุชุฌุงูุฒ 10 ูููุงุช)
- ุชุจุฏุฃ ุจุงููุนูููุฉ ุงูุฃูู
- ุชุฌุฐุจ ุงูุชุจุงู ุงููุงุฑุฆ
- ุชุณุชุฎุฏู ุฃุณุงููุจ ูุชููุนุฉ (ุฎุจุฑูุ ุชุณุงุคููุ ุชุดูููู)
- ููุงุณุจุฉ ูุทุจูุนุฉ ุงูุฎุจุฑ`,
    
    edit_text: `${basePrompt}

ุฃูุช ูุญุฑุฑ ูุบูู ูุญุชุฑู ูู ุตุญููุฉ ุณุจู. ุญุณูู ุงููุต:
- ุฃุตูุญ ุงูุฃุฎุทุงุก ุงููุบููุฉ ูุงูุฅููุงุฆูุฉ
- ุญุณูู ุงูุตูุงุบุฉ ูุงูุฃุณููุจ
- ุงุฌุนู ุงููุต ุฃูุซุฑ ูุถูุญุงู ูุณูุงุณุฉ
- ุงุญุชูุธ ุจููุณ ุงููุนูู ูุงููุนูููุงุช
- ุงุณุชุฎุฏู ุฃุณููุจ ุณุจู ุงูุตุญูู`,
    
    generate_full_article: `${basePrompt}

ุฃูุช ุตุญูู ูุญุชุฑู ูู ุตุญููุฉ ุณุจู. ุงูุชุจ ููุงูุงู ูุงููุงู:
- ุงุจุฏุฃ ุจููุฏูุฉ ูููุฉ ุชุฌุฐุจ ุงููุงุฑุฆ
- ุงูุชุจ ููุฑุงุช ูุตูุฑุฉ ููุชุฑุงุจุทุฉ
- ุฑูุฒ ุนูู ุงูุญูุงุฆู ูุงููุนูููุงุช
- ุงุณุชุฎุฏู ูุบุฉ ูุงุถุญุฉ ููุจุงุดุฑุฉ
- ุงุฎุชู ุจุฎุงุชูุฉ ููุงุณุจุฉ
- ุงุฌุนู ุงูููุงู ูุชูุงุฒูุงู ูุดุงููุงู`,
    
    analytical_report: `${basePrompt}

ุฃูุช ูุญูู ุตุญูู ูู ุตุญููุฉ ุณุจู. ุงูุชุจ ุชูุฑูุฑุงู ุชุญููููุงู:
- ุญูู ุงูููุถูุน ูู ุฌูุงูุจ ูุชุนุฏุฏุฉ
- ูุฏู ุขุฑุงุก ูุชุญูููุงุช ูุชูุงุฒูุฉ
- ุงุณุชุฎุฏู ุฃุฏูุฉ ููุตุงุฏุฑ ููุซููุฉ
- ุงูุชุจ ุจุฃุณููุจ ุชุญูููู ุงุญุชุฑุงูู
- ูุฏู ุฑุคู ูุชููุนุงุช ููุทููุฉ`,
    
    summarize: `${basePrompt}

ุฃูุช ุฎุจูุฑ ูู ุงูุชูุฎูุต ุงูุตุญูู. ูุฎุต ุงููุต:
- ุงุณุชุฎุฑุฌ ุงูููุงุท ุงูุฑุฆูุณูุฉ
- ุงูุชุจ ููุฎุตุงู ูุงุถุญุงู ููุฎุชุตุฑุงู
- ุฑูุฒ ุนูู ุงููุนูููุงุช ุงููููุฉ
- ุงุณุชุฎุฏู ูุบุฉ ุจุณูุทุฉ ููุจุงุดุฑุฉ
- ูุง ุชุชุฌุงูุฒ 3-4 ุฌูู`,
    
    expand: `${basePrompt}

ุฃูุช ุตุญูู ูุญุชุฑู ูู ุตุญููุฉ ุณุจู. ูุณุน ุงููุต:
- ุฃุถู ุชูุงุตูู ููุนูููุงุช ุฅุถุงููุฉ
- ุงุฑุจุท ุงูููุถูุน ุจุณูุงู ุฃูุณุน
- ูุฏู ุฎูููุฉ ูุชูุงุตูู ูููุฉ
- ุงุญุชูุธ ุจุฃุณููุจ ุณุจู ุงูุตุญูู
- ุงุฌุนู ุงููุญุชูู ุฃูุซุฑ ุดููููุฉ`,
    
    translate: `${basePrompt}

ุฃูุช ูุชุฑุฌู ูุญุชุฑู. ุชุฑุฌู ุงููุต:
- ุงุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ูุตุญู ูุงุถุญุฉ
- ุงุญุชูุธ ุจุงููุนูู ูุงูุณูุงู
- ุชุฃูุฏ ูู ุฏูุฉ ุงูุชุฑุฌูุฉ
- ุงุณุชุฎุฏู ูุตุทูุญุงุช ููุงุณุจุฉ
- ุงุฌุนู ุงูุชุฑุฌูุฉ ุทุจูุนูุฉ ููููููุฉ`,
    
    extract_keywords: `${basePrompt}

ุฃูุช ุฎุจูุฑ ูู ุชุญููู ุงููุญุชูู ูุงุณุชุฎุฑุงุฌ ุงููููุงุช ุงูููุชุงุญูุฉ. ุงุณุชุฎุฑุฌ ูู ุงููุต:
- ุงููููุงุช ุงูููุชุงุญูุฉ ุงูุฑุฆูุณูุฉ (5-8 ูููุงุช)
- ุงููุตุทูุญุงุช ุงููููุฉ
- ุงูููุงููู ุงูุฃุณุงุณูุฉ
- ุงูุนูุงููู ุงููุฑุนูุฉ ุงููุญุชููุฉ

ุฃุฑุฌุน ุงููุชุงุฆุฌ ููุตููุฉ ุจููุงุตูุ ุจุฏูู ุชุฑููู ุฃู ุฑููุฒ ุฅุถุงููุฉ.`
  };
  
  return actionPrompts[action] || basePrompt;
}

// ุจูุงุก ุงูุจุฑููุจุช ุญุณุจ ููุน ุงููููุฉ
function buildUserPrompt(action: SmartEditorAction, content: string, context?: any): string {
  const { title, category, tags, isGPSNews } = context || {};
  
  const contextInfo = [];
  if (title) contextInfo.push(`ุงูุนููุงู: ${title}`);
  if (category) contextInfo.push(`ุงูุชุตููู: ${category}`);
  if (tags?.length) contextInfo.push(`ุงููุณูู: ${tags.join(', ')}`);
  if (isGPSNews) contextInfo.push('ููุน ุงูุฎุจุฑ: GPS');
  
  const contextString = contextInfo.length > 0 ? `\n\nูุนูููุงุช ุฅุถุงููุฉ:\n${contextInfo.join('\n')}` : '';
  
  switch (action) {
    case 'generate_title':
      return `ุงูุชุฑุญ 3 ุนูุงููู ุฌุฐุงุจุฉ ูููุงู ุจูุงุกู ุนูู ูุฐุง ุงููุญุชูู:\n\n${content}${contextString}

ุงูุชุจ ูู ุนููุงู ูู ุณุทุฑ ูููุตู ูุงุจุฏุฃ ุจุฑูู (1. 2. 3.)`;
      
    case 'edit_text':
      return `ุฃุนุฏ ุตูุงุบุฉ ูุฐุง ุงููุต ุจุฃุณููุจ ุฃูุถู:\n\n${content}${contextString}

ุงุญุฑุต ุนูู ุชุญุณูู ุงูุฃุณููุจ ูุงููุถูุญ ูุน ุงูุญูุงุธ ุนูู ุงููุนูู`;
      
    case 'generate_full_article':
      return `ุงูุชุจ ููุงูุงู ุตุญููุงู ูุงููุงู ุญูู: ${content}${contextString}

ุงูุจููุฉ ุงููุทููุจุฉ:
1. ููุฏูุฉ ูููุฉ (100-150 ูููุฉ)
2. ุฌุณู ุงูููุงู ููุณู ูููุฑุงุช (300-500 ูููุฉ)
3. ุฎุงุชูุฉ ููุงุณุจุฉ (50-100 ูููุฉ)

ุงุณุชุฎุฏู ุฃุณููุจ ุณุจู ุงูุตุญูู ูุฃุถู ูุนูููุงุช ุฐุงุช ุตูุฉ`;
      
    case 'analytical_report':
      return `ุงูุชุจ ุชูุฑูุฑุงู ุชุญููููุงู ุญูู: ${content}${contextString}

ุงูุจููุฉ ุงููุทููุจุฉ:
1. ุชุญููู ุงููุถุน ุงูุญุงูู
2. ุงูุฃุณุจุงุจ ูุงูุนูุงูู ุงููุคุซุฑุฉ
3. ุงูุขุซุงุฑ ูุงูุชุฏุงุนูุงุช
4. ุงูุชููุนุงุช ูุงูุญููู ุงูููุชุฑุญุฉ

ูุฏู ุชุญูููุงู ูุชูุงุฒูุงู ููุจููุงู ุนูู ุญูุงุฆู`;
      
    case 'summarize':
      return `ูุฎุต ูุฐุง ุงููุต ูู 3-4 ุฌูู ูุงุถุญุฉ:\n\n${content}${contextString}

ุฑูุฒ ุนูู ุงูููุงุท ุงูุฑุฆูุณูุฉ ูุงุณุชุฎุฏู ูุบุฉ ุจุณูุทุฉ`;
      
    case 'expand':
      return `ูุณุน ูุฐุง ุงููุต ุจุงููุฒูุฏ ูู ุงูุชูุงุตูู ูุงููุนูููุงุช:\n\n${content}${contextString}

ุฃุถู ุฎูููุฉ ูุชูุงุตูู ูููุฉ ูุชุนููู ุงูููู`;
      
    case 'translate':
      return `ุชุฑุฌู ูุฐุง ุงููุต ุฅูู ุงูุนุฑุจูุฉ ุงููุตุญู:\n\n${content}${contextString}

ุงุณุชุฎุฏู ูุบุฉ ูุงุถุญุฉ ููููููุฉ ูููุงุณุจุฉ ููุตุญุงูุฉ`;
      
    case 'extract_keywords':
      return `ุงุณุชุฎุฑุฌ ุงููููุงุช ุงูููุชุงุญูุฉ ูู ูุฐุง ุงููุต:\n\n${content}${contextString}

ุฃุฑุฌุน ุงููููุงุช ุงูููุชุงุญูุฉ ููุตููุฉ ุจููุงุตูุ ุจุฏูู ุชุฑููู ุฃู ุฑููุฒ ุฅุถุงููุฉ.`;
      
    default:
      return content;
  }
}

export async function POST(request: NextRequest) {
  let action: string = '', content: string = '', context: any;
  
  try {
    const body = await request.json();
    action = body.type || body.action || '';
    content = body.content || '';
    context = body.context;
    
    if (!content || !action) {
      return NextResponse.json(
        { error: 'ุงููุญุชูู ูููุน ุงููููุฉ ูุทููุจุงู' },
        { status: 400 }
      );
    }
    
    // ุงูุชุญูู ูู ูุฌูุฏ ููุชุงุญ API
    if (!process.env.OPENAI_API_KEY && !process.env.OPENAI_AI_EDITOR_KEY) {
      console.error('OpenAI API key not found');
      return NextResponse.json({
        result: getMockResponse(action, content),
        mock: true
      });
    }
    
    // ุจูุงุก ุงูุฑุณุงุฆู ููุฐูุงุก ุงูุงุตุทูุงุนู
    const systemPrompt = getSystemPrompt(action as SmartEditorAction);
    const userPrompt = buildUserPrompt(action as SmartEditorAction, content, context);
    
    console.log('๐ ุทูุจ ุงููุญุฑุฑ ุงูุฐูู:', { action, contentLength: content.length });
    
    // ุงุณุชุฏุนุงุก OpenAI
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
      ],
      temperature: 0.7,
      max_tokens: action === 'generate_full_article' || action === 'analytical_report' ? 2000 : 1000,
    });
    
    const result = completion.choices[0].message.content;
    
    // ุชูุณูู ุงููุชูุฌุฉ ุญุณุจ ููุน ุงููููุฉ
    let formattedResult = result;
    
    if (action === 'generate_title') {
      // ุชุญููู ุงูุนูุงููู ุฅูู ูุตูููุฉ
      const titles = result?.split('\n')
        .filter(line => line.trim())
        .map(line => line.replace(/^[-*โข\d.]\s*/, '').trim());
      
      formattedResult = titles?.join('\n') || '';
    }
    
    console.log('โ ุชู ุชูููุฐ ุงูุทูุจ ุจูุฌุงุญ:', { action, resultLength: formattedResult?.length });
    
    return NextResponse.json({
      result: formattedResult,
      action,
      timestamp: new Date().toISOString(),
      metadata: {
        model: 'gpt-4',
        tokens: completion.usage?.total_tokens,
        isGPSNews: context?.isGPSNews || false
      }
    });
    
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุงููุญุฑุฑ ุงูุฐูู:', error);
    
    // ูู ุญุงูุฉ ุงูุฎุทุฃุ ุฅุฑุฌุงุน ูุต ุชุฌุฑูุจู
    return NextResponse.json({
      result: getMockResponse(action, content),
      mock: true,
      error: error instanceof Error ? error.message : 'ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุทูุจ'
    });
  }
}

// ูุตูุต ุชุฌุฑูุจูุฉ ูู ุญุงูุฉ ุนุฏู ุชููุฑ API
function getMockResponse(action: string, content: string): string {
  const mockResponses = {
    generate_title: `1. ุนููุงู ุฅุฎุจุงุฑู: ุชุทูุฑุงุช ูููุฉ ูู ุงูููุถูุน ุงููุทุฑูุญ
2. ุนููุงู ุชุดูููู: ููู ูุคุซุฑ ูุฐุง ุงูููุถูุน ุนูู ุญูุงุชูุง ุงูููููุฉุ
3. ุนููุงู ูุตูู: ุชุญููู ุดุงูู ููููุถูุน ูุฃุจุนุงุฏู ุงููุฎุชููุฉ`,
    
    edit_text: `[ูุต ูุญุฑุฑ ููุญุณู] ${content.substring(0, 100)}... ุชู ุชุญุณูู ุงูุฃุณููุจ ูุงููุถูุญ ูุน ุงูุญูุงุธ ุนูู ุงููุนูู ุงูุฃุณุงุณู.`,
    
    generate_full_article: `ูู ุธู ุงูุชุทูุฑุงุช ุงููุชุณุงุฑุนุฉ ุงูุชู ูุดูุฏูุง ุงูุนุงูู ุงููููุ ูุจุฑุฒ ูุฐุง ุงูููุถูุน ูุฃุญุฏ ุฃูู ุงููุถุงูุง ุงูุชู ุชุณุชุญู ุงูุงูุชูุงู ูุงูุชุญููู.

ูุดูู ูุฐุง ุงูููุถูุน ุชุญุฏูุงู ูุจูุฑุงู ุฃูุงู ูุฎุชูู ุงูุฌูุงุช ุงููุนููุฉุ ุญูุซ ูุชุทูุจ ูุนุงูุฌุฉ ุดุงููุฉ ุชุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุฌููุน ุงูุฃุจุนุงุฏ ูุงูุชุฏุงุนูุงุช ุงููุญุชููุฉ. ูุชุดูุฑ ุงูุฏุฑุงุณุงุช ูุงูุชุญูููุงุช ุฅูู ุฃู ูุฐุง ุงูููุถูุน ุณูููู ูู ุชุฃุซูุฑ ูุจูุฑ ุนูู ูุณุชูุจู ุงููุทุงุน ุงููุนูู.

ูู ุงูููู ุฃู ูุฏุฑู ุฃู ูุนุงูุฌุฉ ูุฐุง ุงูููุถูุน ุชุชุทูุจ ุชุนุงููุงู ูุซููุงู ุจูู ุฌููุน ุงูุฃุทุฑุงู ุงููุนููุฉุ ูุน ุถุฑูุฑุฉ ูุถุน ุฎุทุท ุงุณุชุฑุงุชูุฌูุฉ ุทูููุฉ ุงููุฏู ุชุถูู ุชุญููู ุงููุชุงุฆุฌ ุงููุฑุฌูุฉ.

ูู ุงูุฎุชุงูุ ูุจูู ูุฐุง ุงูููุถูุน ูู ุฃูู ุงูุชุญุฏูุงุช ุงูุชู ุชูุงุฌููุงุ ููุชุทูุจ ููุง ุฌููุนุงู ุงูุนูู ุงูุฌุงุฏ ูุงููุชูุงุตู ูุถูุงู ูุนุงูุฌุชู ุจุงูุดูู ุงูุฃูุซู.`,
    
    analytical_report: `ุชุญููู ุงููุถุน ุงูุญุงูู:
ูุดูุฏ ุงูููุถูุน ุชุทูุฑุงุช ูููุฉ ุชุชุทูุจ ุชุญูููุงู ุฏูููุงู ููุชุฃููุงู.

ุงูุฃุณุจุงุจ ูุงูุนูุงูู ุงููุคุซุฑุฉ:
- ุงูุนุงูู ุงูุฃูู: ุชุฃุซูุฑ ูุจุงุดุฑ ุนูู ุงููุชุงุฆุฌ
- ุงูุนุงูู ุงูุซุงูู: ุฏูุฑ ููู ูู ุชุดููู ุงููุณุชูุจู
- ุงูุนุงูู ุงูุซุงูุซ: ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ููุชูููุฉ

ุงูุขุซุงุฑ ูุงูุชุฏุงุนูุงุช:
ูู ุงููุชููุน ุฃู ูููู ููุฐุง ุงูููุถูุน ุชุฃุซูุฑุงุช ุฅูุฌุงุจูุฉ ูุณูุจูุฉ ุนูู ุงููุฏู ุงููุตูุฑ ูุงูุทููู.

ุงูุชููุนุงุช ูุงูุญููู:
ูุญุชุงุฌ ุงูููุถูุน ุฅูู ูุนุงูุฌุฉ ุดุงููุฉ ุชุนุชูุฏ ุนูู ุงูุชุนุงูู ูุงูุชูุณูู ุจูู ุฌููุน ุงูุฃุทุฑุงู ุงููุนููุฉ.`,
    
    summarize: `โข ุงูููุทุฉ ุงูุฃููู: ููุฎุต ููู ูู ุงููุต ุงูุฃุตูู
โข ุงูููุทุฉ ุงูุซุงููุฉ: ูุนูููุฉ ุฑุฆูุณูุฉ ุฃุฎุฑู
โข ุงูููุทุฉ ุงูุซุงูุซุฉ: ุฎูุงุตุฉ ุงูููุถูุน ุงูุฃุณุงุณูุฉ`,
    
    expand: `[ูุต ููุณุน] ${content.substring(0, 50)}... ุชู ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุชูุงุตูู ูุงูุฎูููุฉ ุงููููุฉ ูุชุนููู ููู ุงูููุถูุน ูุชูุฏูู ุฑุคูุฉ ุฃูุซุฑ ุดููููุฉ.`,
    
    translate: `[ุชุฑุฌูุฉ ูุญุณูุฉ] ${content.substring(0, 100)}... ุชูุช ุงูุชุฑุฌูุฉ ุฅูู ุงูุนุฑุจูุฉ ุงููุตุญู ูุน ุงูุญูุงุธ ุนูู ุงููุนูู ูุงูุณูุงู ุงูุฃุตูู.`,
    
    extract_keywords: `ูููุฉ ููุชุงุญูุฉ 1, ูููุฉ ููุชุงุญูุฉ 2, ูููุฉ ููุชุงุญูุฉ 3, ูููุฉ ููุชุงุญูุฉ 4, ูููุฉ ููุชุงุญูุฉ 5`
  };
  
  return mockResponses[action as keyof typeof mockResponses] || mockResponses.edit_text;
}

// ููุญุตูู ุนูู ูุนูููุงุช ุญูู API
export async function GET() {
  return NextResponse.json({
    status: 'active',
    name: 'ุงููุญุฑุฑ ุงูุฐูู ูุตุญููุฉ ุณุจู',
    version: '1.0.0',
    actions: [
      'generate_title',
      'edit_text', 
      'generate_full_article',
      'analytical_report',
      'summarize',
      'expand',
      'translate',
      'extract_keywords'
    ],
    features: [
      'ุฃุณููุจ ุณุจู ุงูุตุญูู',
      'ุฏุนู ุฃุฎุจุงุฑ GPS',
      'ุชุญููู ุฐูู ูููุญุชูู',
      'ุชุฑุฌูุฉ ุงุญุชุฑุงููุฉ',
      'ุชูููุฏ ูุญุชูู ูุชูุงูู'
    ]
  });
} 