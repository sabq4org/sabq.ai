#!/bin/bash

# ุณูุฑูุจุช ุฅุนุฏุงุฏ ูุชุดุบูู ุงููุดุฑูุน ุนูู ุงูุณูุฑูุฑ
echo "๐ ุฅุนุฏุงุฏ ุงููุดุฑูุน ุนูู ุงูุณูุฑูุฑ..."

# 1. ุชุซุจูุช ุงูุชุจุนูุงุช
echo "๐ฆ ุชุซุจูุช ุงูุชุจุนูุงุช..."
npm install --production

# 2. ุฅูุดุงุก ูููุงุช Prisma
echo "๐ง ุฅุนุฏุงุฏ Prisma..."
npx prisma generate

# 3. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
echo "๐๏ธ ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
npx prisma db push --skip-generate

# 4. ุจูุงุก ุงููุดุฑูุน (ุฅุฐุง ูู ููู ูุจูู)
if [ ! -d ".next" ]; then
  echo "๐๏ธ ุจูุงุก ุงููุดุฑูุน..."
  npm run build
fi

# 5. ุงูุชุญูู ูู PM2
if command -v pm2 &> /dev/null; then
  echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู ุนุจุฑ PM2..."
  pm2 restart ecosystem.config.js --update-env
  pm2 save
  echo "โ ุชู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู"
else
  echo "โ๏ธ PM2 ุบูุฑ ูุซุจุช. ุชุดุบูู ุงูุชุทุจูู ูุจุงุดุฑุฉ..."
  npm run start
fi

echo ""
echo "โ ุชู ุฅุนุฏุงุฏ ุงููุดุฑูุน ุจูุฌุงุญ!"
echo ""
echo "๐ ููุชุญูู ูู ุญุงูุฉ ุงูุชุทุจูู:"
echo "   pm2 status"
echo "   pm2 logs" 